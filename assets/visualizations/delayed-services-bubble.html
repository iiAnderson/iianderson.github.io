<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TOC Performance Analysis</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            padding: 20px;
            background-color: #f5f5f5;
            color: #333;
        }

        @media (prefers-color-scheme: dark) {
            body {
                background-color: #1a1a1a;
                color: #e0e0e0;
            }
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            padding: 30px;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        @media (prefers-color-scheme: dark) {
            .container {
                background: #2d2d2d;
                box-shadow: 0 2px 8px rgba(0,0,0,0.3);
            }
        }

        h1 {
            font-size: 28px;
            font-weight: 600;
            margin-bottom: 20px;
            color: #1a1a1a;
        }

        @media (prefers-color-scheme: dark) {
            h1 {
                color: #e0e0e0;
            }
        }

        .controls {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
            padding: 20px;
            background-color: #f9fafb;
            border-radius: 8px;
        }

        @media (prefers-color-scheme: dark) {
            .controls {
                background-color: #1f1f1f;
            }
        }

        .control-group {
            display: flex;
            flex-direction: column;
        }

        .controls label {
            font-size: 14px;
            font-weight: 500;
            margin-bottom: 8px;
            color: #374151;
        }

        @media (prefers-color-scheme: dark) {
            .controls label {
                color: #d1d5db;
            }
        }

        .controls select,
        .controls input {
            padding: 8px 12px;
            font-size: 14px;
            border: 1px solid #ccc;
            border-radius: 6px;
            background-color: white;
            cursor: pointer;
        }

        @media (prefers-color-scheme: dark) {
            .controls select,
            .controls input {
                background-color: #3d3d3d;
                border-color: #555;
                color: #e0e0e0;
            }
        }

        .controls button {
            padding: 8px 16px;
            font-size: 14px;
            background-color: #3b82f6;
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            align-self: flex-end;
        }

        .controls button:hover {
            background-color: #2563eb;
        }

        .info-box {
            padding: 15px;
            background-color: #eff6ff;
            border-left: 4px solid #3b82f6;
            border-radius: 4px;
            margin-bottom: 20px;
            font-size: 14px;
            line-height: 1.6;
        }

        @media (prefers-color-scheme: dark) {
            .info-box {
                background-color: #1e3a5f;
                border-left-color: #60a5fa;
            }
        }

        .legend {
            display: flex;
            gap: 20px;
            flex-wrap: wrap;
            margin-top: 10px;
        }

        .legend-item {
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: 13px;
        }

        .legend-dot {
            width: 12px;
            height: 12px;
            border-radius: 50%;
        }

        .chart-container {
            position: relative;
            height: 500px;
            margin-bottom: 30px;
        }

        .tables-container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
            gap: 20px;
            margin-top: 30px;
        }

        .table-wrapper {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }

        @media (prefers-color-scheme: dark) {
            .table-wrapper {
                background: #2d2d2d;
            }
        }

        .table-wrapper h2 {
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 15px;
        }

        .table-wrapper.best h2 {
            color: #10b981;
        }

        .table-wrapper.worst h2 {
            color: #ef4444;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            font-size: 14px;
        }

        th {
            text-align: left;
            padding: 10px 8px;
            border-bottom: 2px solid #e5e7eb;
            font-weight: 600;
        }

        @media (prefers-color-scheme: dark) {
            th {
                border-bottom-color: #4b5563;
            }
        }

        td {
            padding: 10px 8px;
            border-bottom: 1px solid #f3f4f6;
        }

        @media (prefers-color-scheme: dark) {
            td {
                border-bottom-color: #374151;
            }
        }

        .text-right {
            text-align: right;
        }

        .rank {
            font-weight: 600;
            color: #6b7280;
        }

        @media (prefers-color-scheme: dark) {
            .rank {
                color: #9ca3af;
            }
        }
    </style>
</head>
<body>
    <div id="loading-message" style="text-align: center; padding: 50px; font-size: 18px;">
        Loading data...
    </div>
    <div class="container" style="display: none;">
        <h1>TOC Performance Analysis</h1>

        <div class="controls">
            <div class="control-group">
                <label for="date-range">Date Range</label>
                <select id="date-range">
                    <option value="all">All Data</option>
                    <option value="this_week">This Week</option>
                    <option value="last_week">Last Week</option>
                    <option value="this_month">This Month</option>
                    <option value="custom">Custom Range</option>
                </select>
            </div>

            <div class="control-group">
                <label for="delay-threshold">Delay Threshold</label>
                <select id="delay-threshold">
                    <option value="5">&gt;5 minutes</option>
                    <option value="15">&gt;15 minutes</option>
                    <option value="30">&gt;30 minutes</option>
                </select>
            </div>

            <div class="control-group" id="custom-start-group" style="display:none;">
                <label for="custom-start">Start Date</label>
                <input type="date" id="custom-start">
            </div>

            <div class="control-group" id="custom-end-group" style="display:none;">
                <label for="custom-end">End Date</label>
                <input type="date" id="custom-end">
            </div>

            <div class="control-group" id="custom-apply-group" style="display:none;">
                <label>&nbsp;</label>
                <button id="apply-custom">Apply</button>
            </div>
        </div>

        <div class="info-box">
            <strong>Chart Guide:</strong>
            <ul style="margin-left: 20px; margin-top: 8px;">
                <li><strong>Bubble size:</strong> Percentage of services delayed beyond the selected threshold</li>
                <li><strong>X-axis:</strong> Average delay in minutes</li>
                <li><strong>Y-axis:</strong> Standard deviation (consistency - lower is more consistent)</li>
            </ul>
            <div class="legend">
                <div class="legend-item">
                    <div class="legend-dot" style="background-color: #10b981;"></div>
                    <span>&lt;10% delayed</span>
                </div>
                <div class="legend-item">
                    <div class="legend-dot" style="background-color: #f59e0b;"></div>
                    <span>10-20% delayed</span>
                </div>
                <div class="legend-item">
                    <div class="legend-dot" style="background-color: #ef4444;"></div>
                    <span>20-30% delayed</span>
                </div>
                <div class="legend-item">
                    <div class="legend-dot" style="background-color: #7c3aed;"></div>
                    <span>&gt;30% delayed</span>
                </div>
            </div>
        </div>

        <div class="chart-container">
            <canvas id="bubbleChart"></canvas>
        </div>

        <div class="tables-container">
            <div class="table-wrapper best">
                <h2>Top 5 Best Performers</h2>
                <table id="best-table">
                    <thead>
                        <tr>
                            <th>Rank</th>
                            <th>TOC</th>
                            <th class="text-right">Avg Delay</th>
                            <th class="text-right">Delayed</th>
                            <th class="text-right">Services</th>
                        </tr>
                    </thead>
                    <tbody id="best-tbody"></tbody>
                </table>
            </div>

            <div class="table-wrapper worst">
                <h2>Top 5 Worst Performers</h2>
                <table id="worst-table">
                    <thead>
                        <tr>
                            <th>Rank</th>
                            <th>TOC</th>
                            <th class="text-right">Avg Delay</th>
                            <th class="text-right">Delayed</th>
                            <th class="text-right">Services</th>
                        </tr>
                    </thead>
                    <tbody id="worst-tbody"></tbody>
                </table>
            </div>
        </div>
    </div>

    <script>
        const tocNames = {
            'AW': 'Transport for Wales Rail', 'CC': 'c2c', 'CH': 'Chiltern Railways',
            'CS': 'Caledonian Sleeper', 'EM': 'East Midlands Railway', 'ES': 'Eurostar',
            'GC': 'Grand Central', 'GN': 'Great Northern', 'GR': 'London North Eastern Railway',
            'GW': 'Great Western Railway', 'GX': 'Gatwick Express', 'HT': 'Hull Trains',
            'HX': 'Heathrow Express', 'IL': 'Island Line', 'LD': 'Lumo',
            'LE': 'Greater Anglia', 'LM': 'West Midlands Trains', 'LO': 'London Overground',
            'ME': 'Merseyrail', 'NT': 'Northern Trains', 'SE': 'Southeastern',
            'SN': 'Southern', 'SR': 'ScotRail', 'SW': 'South Western Railway',
            'TL': 'Thameslink', 'TP': 'TransPennine Express', 'VT': 'Avanti West Coast',
            'XC': 'CrossCountry', 'XR': 'Elizabeth line'
        };

        let chartInstance = null;
        let allData = [];
        let currentThreshold = 5;
        let isDataLoaded = false;

        // Helper functions
        function groupBy(array, key) {
            return array.reduce((result, item) => {
                const group = item[key];
                if (!result[group]) result[group] = [];
                result[group].push(item);
                return result;
            }, {});
        }

        function mean(array, key) {
            if (array.length === 0) return 0;
            return array.reduce((sum, item) => sum + item[key], 0) / array.length;
        }

        function sum(array, key) {
            return array.reduce((total, item) => total + item[key], 0);
        }

        function getColor(pctDelayed) {
            if (pctDelayed < 10) return '#10b981';
            if (pctDelayed < 20) return '#f59e0b';
            if (pctDelayed < 30) return '#ef4444';
            return '#7c3aed';
        }

        function processData(data, startDate, endDate, threshold) {
            const filteredData = data.filter(d => d.date >= startDate && d.date <= endDate);
            const grouped = groupBy(filteredData, 'toc');

            const bubbleData = Object.keys(grouped)
                .filter(toc => tocNames[toc])
                .map(toc => {
                    const tocData = grouped[toc];
                    const avgDelay = mean(tocData, 'avg_delay_minutes');
                    const avgStdDev = mean(tocData, 'stddev_delay');

                    let pctDelayed;
                    if (threshold === 5) {
                        pctDelayed = 100 - mean(tocData, 'pct_0_5_mins');
                    } else if (threshold === 15) {
                        pctDelayed = mean(tocData, 'pct_15_30_mins') + mean(tocData, 'pct_30_plus_mins');
                    } else {
                        pctDelayed = mean(tocData, 'pct_30_plus_mins');
                    }

                    const totalServices = sum(tocData, 'num_services');

                    return {
                        x: avgDelay,
                        y: avgStdDev,
                        r: Math.sqrt(pctDelayed) * 3, // Scale radius for visibility
                        toc: tocNames[toc],
                        tocCode: toc,
                        avgDelay: avgDelay,
                        stdDev: avgStdDev,
                        pctDelayed: pctDelayed,
                        totalServices: totalServices,
                        color: getColor(pctDelayed)
                    };
                });

            return bubbleData;
        }

        function updateChart(data) {
            if (chartInstance) {
                chartInstance.destroy();
            }

            const ctx = document.getElementById('bubbleChart').getContext('2d');
            chartInstance = new Chart(ctx, {
                type: 'bubble',
                data: {
                    datasets: [{
                        label: 'TOC Performance',
                        data: data,
                        backgroundColor: data.map(d => d.color + '80'), // Add transparency
                        borderColor: data.map(d => d.color),
                        borderWidth: 2
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: false
                        },
                        tooltip: {
                            callbacks: {
                                title: function(context) {
                                    return context[0].raw.toc;
                                },
                                label: function(context) {
                                    const data = context.raw;
                                    return [
                                        `Code: ${data.tocCode}`,
                                        `Avg Delay: ${data.avgDelay.toFixed(2)} mins`,
                                        `Std Deviation: ${data.stdDev.toFixed(2)} mins`,
                                        `Delayed >${currentThreshold} mins: ${data.pctDelayed.toFixed(2)}%`,
                                        `Total Services: ${data.totalServices.toLocaleString()}`
                                    ];
                                }
                            }
                        }
                    },
                    scales: {
                        x: {
                            title: {
                                display: true,
                                text: 'Average Delay (minutes)'
                            }
                        },
                        y: {
                            title: {
                                display: true,
                                text: 'Standard Deviation (minutes)'
                            }
                        }
                    }
                }
            });

            updateTables(data);
        }

        function updateTables(data) {
            const sorted = [...data].sort((a, b) => a.pctDelayed - b.pctDelayed);
            const best5 = sorted.slice(0, 5);
            const worst5 = sorted.slice(-5).reverse();

            const bestTbody = document.getElementById('best-tbody');
            const worstTbody = document.getElementById('worst-tbody');

            bestTbody.innerHTML = best5.map((toc, idx) => `
                <tr>
                    <td class="rank">${idx + 1}</td>
                    <td>${toc.toc}</td>
                    <td class="text-right">${toc.avgDelay.toFixed(2)} min</td>
                    <td class="text-right">${toc.pctDelayed.toFixed(2)}%</td>
                    <td class="text-right">${toc.totalServices.toLocaleString()}</td>
                </tr>
            `).join('');

            worstTbody.innerHTML = worst5.map((toc, idx) => `
                <tr>
                    <td class="rank">${idx + 1}</td>
                    <td>${toc.toc}</td>
                    <td class="text-right">${toc.avgDelay.toFixed(2)} min</td>
                    <td class="text-right">${toc.pctDelayed.toFixed(2)}%</td>
                    <td class="text-right">${toc.totalServices.toLocaleString()}</td>
                </tr>
            `).join('');
        }

        function getDateRange() {
            const dates = allData.map(d => d.date).sort();
            return { min: dates[0], max: dates[dates.length - 1] };
        }

        function getDateRangeFromSelection(selection, customStart, customEnd) {
            const dateRange = getDateRange();
            const maxDate = new Date(dateRange.max);
            let startDate, endDate;

            switch(selection) {
                case 'this_week':
                    endDate = maxDate;
                    startDate = new Date(maxDate);
                    startDate.setDate(startDate.getDate() - 7);
                    break;
                case 'last_week':
                    endDate = new Date(maxDate);
                    endDate.setDate(endDate.getDate() - 7);
                    startDate = new Date(endDate);
                    startDate.setDate(startDate.getDate() - 7);
                    break;
                case 'this_month':
                    endDate = maxDate;
                    startDate = new Date(maxDate);
                    startDate.setDate(1);
                    break;
                case 'custom':
                    startDate = new Date(customStart);
                    endDate = new Date(customEnd);
                    break;
                default:
                    startDate = new Date(dateRange.min);
                    endDate = new Date(dateRange.max);
            }

            const formatDate = (d) => d.toISOString().split('T')[0];
            return { start: formatDate(startDate), end: formatDate(endDate) };
        }

        // Event listeners
        document.getElementById('date-range').addEventListener('change', function(e) {
            const isCustom = e.target.value === 'custom';
            document.getElementById('custom-start-group').style.display = isCustom ? 'flex' : 'none';
            document.getElementById('custom-end-group').style.display = isCustom ? 'flex' : 'none';
            document.getElementById('custom-apply-group').style.display = isCustom ? 'flex' : 'none';

            if (!isCustom) {
                const range = getDateRangeFromSelection(e.target.value);
                const data = processData(allData, range.start, range.end, currentThreshold);
                updateChart(data);
            }
        });

        document.getElementById('delay-threshold').addEventListener('change', function(e) {
            currentThreshold = parseInt(e.target.value);
            const selectedRange = document.getElementById('date-range').value;
            const customStart = document.getElementById('custom-start').value;
            const customEnd = document.getElementById('custom-end').value;
            const range = getDateRangeFromSelection(selectedRange, customStart, customEnd);
            const data = processData(allData, range.start, range.end, currentThreshold);
            updateChart(data);
        });

        document.getElementById('apply-custom').addEventListener('click', function() {
            const customStart = document.getElementById('custom-start').value;
            const customEnd = document.getElementById('custom-end').value;
            if (customStart && customEnd) {
                const range = getDateRangeFromSelection('custom', customStart, customEnd);
                const data = processData(allData, range.start, range.end, currentThreshold);
                updateChart(data);
            }
        });

        // Load data and initialize
        function initializeVisualization() {
            fetch('./toc-data.json')
                .then(response => {
                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    return response.json();
                })
                .then(data => {
                    allData = data;
                    isDataLoaded = true;

                    const dateRange = getDateRange();
                    document.getElementById('custom-start').value = dateRange.min;
                    document.getElementById('custom-start').min = dateRange.min;
                    document.getElementById('custom-start').max = dateRange.max;
                    document.getElementById('custom-end').value = dateRange.max;
                    document.getElementById('custom-end').min = dateRange.min;
                    document.getElementById('custom-end').max = dateRange.max;

                    const initialData = processData(allData, dateRange.min, dateRange.max, currentThreshold);
                    updateChart(initialData);

                    // Hide loading message
                    document.getElementById('loading-message').style.display = 'none';
                    document.querySelector('.container').style.display = 'block';
                })
                .catch(error => {
                    console.error('Error loading data:', error);
                    document.getElementById('loading-message').innerHTML =
                        '<p style="color: #ef4444;">Error loading data. Please refresh the page.</p>';
                });
        }

        // Initialize on page load
        initializeVisualization();
    </script>
</body>
</html>
